---
/**
 * The system list view component. So we've navigated to /.
 *
 */

interface Props {
  testRun?: boolean;
}

const { testRun } = Astro.props;

// - The whole system to reference. Just import it directly.
import sb, { getAllByType } from "src/data/smallBusinessFlat";
import sbTest from "src/data/smallBusinessFlatTest";
let system;
if (testRun) {
  system = sbTest;
  console.log("ðŸŽ½ TEST RUN SYSTEM");
} else {
  system = sb;
}

// - The title of the area for the main header.
const systemEntries = getAllByType(system, "system") as SystemEntry[];
// There can only be one
if (systemEntries.length > 1) {
  throw new Error(
    "You have defined more than one 'system' entry. That's weird."
  );
}
const systemEntry = systemEntries[0];
const systemTitle = systemEntry.title;

// - The description and emoji of the area.
// const areaEmoji = areaEntry.emoji;

// - All of its other details for the main content.
const systemDescription = await marked.parse(
  wikiLinkify(systemEntry.description)
);

// - An array of the areas that this area contains. Each one of those
//   needs to contain the ID, title, description, isHeader, emoji.
import { getChildren } from "src/data/smallBusinessFlat";
import type { SystemEntry, AreaEntry } from "src/data/smallBusinessFlat";
const areas = getChildren(system, systemEntry.number) as AreaEntry[];

// - Where those descriptions have been rendered to HTML from Markdown.
import { marked } from "marked";
import { markedSmartypants } from "marked-smartypants";
marked.use(markedSmartypants());

// - Wiki-linkify the description
import wikiLinkify from "@helpers/wikiLinkify";

// - To import and use the Slice component.
import Slice from "./common/Slice.astro";
---

<Slice id="Header" className="active-top">
  <div class="layout-grid-left-right">
    <div></div>
    <h1 class="layout-right-item">{systemTitle}</h1>
  </div>
</Slice>

{
  systemDescription ? (
    <Slice id="SystemDescription" className="descriptive-text">
      <div class="layout-grid-left-right">
        <div />
        <div class="layout-right-item" set:html={systemDescription} />
      </div>
    </Slice>
  ) : null
}

<Slice id="ChildrenInParentLabel" className="secondary-content-bg">
  <div class="layout-grid-left-right">
    <div></div>
    <h2 class="layout-right-item">Areas in this system</h2>
  </div>
</Slice>

<Slice id="ChildrenInParentList" className="secondary-content-bg">
  <ol class="acid-list">
    {
      areas.map(async (area) => {
        const areaDescription = await marked.parse(
          wikiLinkify(area.description)
        );
        return (
          <li class="layout-grid-left-right">
            <h3 class="layout-left-item">
              <a href={`/${area.number}`}>{area.number}</a>
            </h3>
            <div class="layout-right-item">
              <h3>
                <a href={`/${area.number}`}>{area.title}</a>
              </h3>
              <div set:html={areaDescription} />
            </div>
          </li>
        );
      })
    }
  </ol>
</Slice>

<style lang="scss">
  @use "@styles/common" as *;

  // TODO when all's settled, these can probably move out to common.scss
  :global(#Header),
  :global(#SystemDescription),
  :global(#ChildrenInParentLabel) {
    // On mobile, override the grid
    @include phone-only {
      .layout-grid-left-right {
        display: block;
      }
      .layout-right-item {
        border: none;
        padding-left: 0;
      }
    }
  }

  #Header {
    h1 {
      margin: 0;
      padding-top: 20px;
    }
  }

  // We copied this whole thing to Area
  // :global(#ChildrenInParentLabel) {
  //   // Border here vs. above, as we don't know if SystemDescription will exist
  //   border-top: 1px solid var(--border-strong);
  //   h2 {
  //     margin: 0;
  //     padding-top: 15px;
  //     padding-bottom: 15px;
  //   }
  //   @include phone-only {
  //     border-bottom: 1px solid lightgray;
  //     h2.layout-right-item {
  //       padding: 10px 0;
  //     }
  //   }
  // }

  // // Also this
  // :global(#ChildrenInParentList) {
  //   border-bottom: 1px solid var(--border-strong);
  //   h2 {
  //     font-size: 1rem;
  //     margin: 0;
  //   }
  //   // Bring the list away from the light grey border a touch
  //   @include phone-only {
  //     ol {
  //       li {
  //         .layout-left-item,
  //         .layout-right-item {
  //           padding-top: 10px;
  //         }
  //       }
  //     }
  //   }
  // }
</style>
