---
/**
 * The area list view component. So we've navigated to
 * /jdex/10-19.
 *
 * Shows the area and all of its categories. Might it be nice to show
 * the header-IDs as well?
 *
 * ```
 * ðŸ•š 10-19 The teens                                        [emoji, big?]
 *      The description of area ten through nineteen.
 *
 * ## 11 The business & its people
 *       Description
 *       11.10 Documents
 *       11.20 Registraions
 *
 * ## 12 Where we trade...
 *          Description
 * ## 13 ...
 *
 * ```
 *
 * So we need:
 * - To be passed the number of the area to render. This is the slug.
 * - The whole system to reference. Just import it directly.
 * - The title of the area for the main header.
 * - The description and emoji of the area.
 * - An array of the categories that this area contains. Each one of those
 *   needs to contain the ID, title, description, emoji.
 * - Where those descriptions have been rendered to HTML from Markdown.
 * - Linking the category header to the category URL.
 * - A breadbreadcrumb to the parent area.
 */

// - To be passed the number of the category to render. This is the slug.
interface Props {
  area: string;
  testRun?: boolean;
}
const { area, testRun } = Astro.props;

import sb from "src/data/smallBusinessFlat";
import sbTest from "src/data/smallBusinessFlatTest";
let system;
console.log("env:", process.env.NODE_ENV);
if (testRun) {
  system = sbTest;
} else {
  system = sb;
}

// - The title of the area for the main header.
const areaEntry = system[area] as AreaEntry;
const areaTitle = areaEntry.title;

// - The description and emoji of the area.
// const areaEmoji = areaEntry.emoji;

// - All of its other details for the main content.
const areaDescription = await marked.parse(wikiLinkify(areaEntry.description));
const areaEntrySb = areaEntry.extensions?.smallBusiness;
const areaExamples =
  areaEntrySb?.examples &&
  (await marked.parse(wikiLinkify(areaEntrySb.examples)));
const areaMoreInfo =
  areaEntrySb?.moreInfo &&
  (await marked.parse(wikiLinkify(areaEntrySb.moreInfo)));
const areaExceptions =
  areaEntrySb?.exceptions &&
  (await marked.parse(wikiLinkify(areaEntrySb.exceptions)));
const areaAlsoSee =
  areaEntrySb?.alsoSee &&
  (await marked.parse(wikiLinkify(areaEntrySb.alsoSee)));
const areaRationale =
  areaEntrySb?.rationale &&
  (await marked.parse(wikiLinkify(areaEntrySb.rationale)));

// - An array of the categories that this area contains. Each one of those
//   needs to contain the ID, title, description, isHeader, emoji.
import { getChildren } from "src/data/smallBusinessFlat";
import type {
  SystemEntry,
  AreaEntry,
  CategoryEntry,
} from "src/data/smallBusinessFlat";
const categories = getChildren(system, area) as CategoryEntry[];

// - Where those descriptions have been rendered to HTML from Markdown.
import { marked } from "marked";
import { markedSmartypants } from "marked-smartypants";
marked.use(markedSmartypants());

// - Wiki-linkify the description
import wikiLinkify from "@helpers/wikiLinkify";

// - To import and use the Slice component.
import Slice from "./common/Slice.astro";

// - A breadbreadcrumb to the parent system.
const parentSNumber = areaEntry.parentNumber;
const parentSEntry = system[parentSNumber] as SystemEntry;
const parentSTitle = parentSEntry.title;
---

<Slice id="SystemBreadcrumb" className="secondary-content-bg">
  <div class="layout-grid-left-right">
    <div></div>
    <h3 class="layout-right-item"><a href="/">{parentSTitle}</a></h3>
  </div>
</Slice>

<Slice id="Header" className="active-top">
  <div class="layout-grid-left-right phone-only">
    <h1 class="layout-left-item">{area} {areaTitle}</h1>
  </div>
  <div class="layout-grid-left-right tablet-portrait-up">
    <h1 class="layout-left-item">{area}</h1>
    <h1 class="layout-right-item">{areaTitle}</h1>
  </div>
</Slice>

{
  areaDescription ? (
    <Slice id="AreaDescription" className="descriptive-text">
      <div class="layout-grid-left-right">
        <div />
        <div class="layout-right-item" set:html={areaDescription} />
      </div>
    </Slice>
  ) : null
}

{
  areaExamples ? (
    <Slice id="AreaExamples" className="descriptive-text">
      <div class="layout-grid-left-right">
        <h3 class="layout-left-item">Examples</h3>
        <div class="layout-right-item" set:html={areaExamples} />
      </div>
    </Slice>
  ) : null
}

{
  areaMoreInfo ? (
    <Slice id="AreaMoreInfo" className="descriptive-text">
      <div class="layout-grid-left-right">
        <h3 class="layout-left-item">More info</h3>
        <div class="layout-right-item" set:html={areaMoreInfo} />
      </div>
    </Slice>
  ) : null
}

{
  areaExceptions ? (
    <Slice id="AreaExceptions" className="descriptive-text">
      <div class="layout-grid-left-right">
        <h3 class="layout-left-item">Exceptions</h3>
        <div class="layout-right-item" set:html={areaExceptions} />
      </div>
    </Slice>
  ) : null
}

{
  areaAlsoSee ? (
    <Slice id="AreaAlsoSee" className="descriptive-text">
      <div class="layout-grid-left-right">
        <h3 class="layout-left-item">Also see</h3>
        <div class="layout-right-item" set:html={areaAlsoSee} />
      </div>
    </Slice>
  ) : null
}

{
  areaRationale ? (
    <Slice id="AreaRationale" className="descriptive-text">
      <div class="layout-grid-left-right">
        <h3 class="layout-left-item">Rationale</h3>
        <div class="layout-right-item" set:html={areaRationale} />
      </div>
    </Slice>
  ) : null
}

<Slice id="ChildrenInParentLabel" className="secondary-content-bg">
  <div class="layout-grid-left-right">
    <div></div>
    <h2 class="layout-right-item">Categories in this area</h2>
  </div>
</Slice>

<Slice id="ChildrenInParentList" className="secondary-content-bg">
  <ol class="acid-list">
    {
      categories.map(async (category) => {
        const categoryDescription = await marked.parse(
          wikiLinkify(category.description)
        );
        return (
          <li class="layout-grid-left-right">
            <h3 class="layout-left-item">
              <a href={`/${category.number}`}>{category.number}</a>
            </h3>
            <div class="layout-right-item">
              <h3>
                <a href={`/${category.number}`}>{category.title}</a>
              </h3>
              <div set:html={categoryDescription} />
            </div>
          </li>
        );
      })
    }
  </ol>
</Slice>

<style lang="scss">
  @use "@styles/common.scss" as *;

  :global(#AreaDescription), // same as SystemDescription
  :global(#ChildrenInParentLabel) {
    // On mobile, override the grid
    @include phone-only {
      .layout-grid-left-right {
        display: block;
      }
      .layout-right-item {
        border: none;
        padding-left: 0;
      }
    }
  }

  // Moved out to common
  // :global(#Header) {
  //   h1 {
  //     margin: 0;
  //     padding-top: 20px;
  //     @include phone-only {
  //       // A word has to be pretty long to need breaking mid-word
  //       // But this is what does it
  //       // hyphens: auto;
  //       // overflow-wrap: break-word;
  //     }
  //   }
  //   .phone-only {
  //     display: none;
  //     @include phone-only {
  //       display: block;
  //     }
  //   }
  //   .tablet-portrait-up {
  //     display: none;
  //     @include tablet-portrait-up {
  //       display: grid;
  //     }
  //   }
  // }

  // moved to common
  // :global(#SystemBreadcrumb) {
  //   h3 {
  //     font-size: 1rem;
  //     font-weight: normal;
  //     margin: 0;
  //   }
  // }

  // moved to common
  // :global(.descriptive-text) {
  //   // All headers within are h3
  //   h3 {
  //     font-size: 1rem;
  //     margin: 0; // Surrounding <p>s handle it
  //   }
  //   // Line the text up with its header by removing top margin
  //   @include tablet-portrait-up {
  //     // This <p> is set:html'd
  //     .layout-right-item :global(p:first-child) {
  //       margin-top: 0;
  //     }
  //   }
  //   // Headers go above the text on mobile, otherwise they take up loads of
  //   // room on the left.
  //   @include phone-only {
  //     .layout-grid-left-right {
  //       grid-auto-flow: row;
  //       grid-template-columns: none;
  //       // Undo the stuff we set for larger screens
  //       .layout-left-item {
  //         justify-self: start;
  //       }
  //       .layout-right-item {
  //         border: none;
  //         padding: unset;
  //       }
  //     }
  //   }
  // }

  :global(#ChildrenInParentLabel) {
    // Border here vs. above, as we don't know if SystemDescription will exist
    border-top: 1px solid var(--border-strong);
    h2 {
      margin: 0;
      padding-top: 15px;
      padding-bottom: 15px;
    }
    @include phone-only {
      border-bottom: 1px solid lightgray;
      h2.layout-right-item {
        padding: 10px 0;
      }
    }
  }

  :global(#ChildrenInParentList) {
    border-bottom: 1px solid var(--border-strong);
    h2 {
      font-size: 1rem;
      margin: 0;
    }
    // Bring the list away from the light grey border a touch
    @include phone-only {
      ol {
        li {
          .layout-left-item,
          .layout-right-item {
            padding-top: 10px;
          }
        }
      }
    }
  }
</style>
