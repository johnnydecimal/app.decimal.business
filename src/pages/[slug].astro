---
import sb from "src/data/smallBusinessFlat";
import type { EntryType } from "src/data/smallBusinessFlat";

import Layout from "@layouts/Layout.astro";
import System from "@components/System.astro";
import Area from "@components/Area.astro";
import Category from "@components/Category.astro";
import ID from "@components/ID.astro";
import OpsManual from "@components/OpsManual.astro";
import HowTo from "@components/HowTo.astro";
import MoreInfo from "@components/MoreInfo.astro";

const { slug } = Astro.params;

// Is it a test run? That's only a possibility if we're in dev, which is how
// we stop sneaky people appending ?env=test in prod and viewing the system.
const testRun =
  import.meta.env.DEV && Astro.url.searchParams.get("env") === "test";

/**
 * This page handles the display of all areas, categories, and IDs. So first
 * we need to figure out which of those things we want. Then we fetch it,
 * then we display it. This is all done with components.
 *
 * If it doesn't exist, show our 04.04.
 *
 * We also need to handle the default case where the user visits /jdex.
 */

let entryType: EntryType | "no-match" | null = null;

console.log("üêå", slug);

if (slug?.match(/^index.html$/)) {
  entryType = "system";
} else if (slug?.match(/^[0-9]0-[0-9]9$/)) {
  entryType = "area";
} else if (slug?.match(/^\d\d$/)) {
  // We've pattern-matched, but does it exist? Gracefully fail if not
  if (!!sb[slug]) {
    entryType = "category";
  } else {
    entryType = "no-match";
  }
} else if (slug?.match(/^\d\d\.\d\d$/)) {
  // We've pattern-matched, but does it exist? Gracefully fail if not
  if (!!sb[slug]) {
    entryType = "id";
  } else {
    entryType = "no-match";
  }
} else if (slug?.match(/^\d\d\.\d\d\+OPS\d+$/)) {
  if (!!sb[slug]) {
    entryType = "ops";
  } else {
    entryType = "no-match";
  }
} else if (slug?.match(/^\d\d\.\d\d\+HOW\d+$/)) {
  if (!!sb[slug]) {
    entryType = "howTo";
  } else {
    entryType = "no-match";
  }
} else if (slug?.match(/^\d\d\.\d\d\+[0-9]/)) {
  if (!!sb[slug]) {
    entryType = "moreInfo";
  } else {
    entryType = "no-match";
  }
} else {
  entryType = "no-match";
  // None of the above
}

console.log("üö™ entryType:", entryType);
---

<Layout testRun={testRun}>
  {entryType === "system" ? <System /> : null}
  {entryType === "area" ? <Area area={slug!} /> : null}
  {entryType === "category" ? <Category category={slug!} /> : null}
  {entryType === "id" ? <ID id={slug!} /> : null}
  {entryType === "ops" ? <OpsManual id={slug!} /> : null}
  {entryType === "howTo" ? <HowTo howToId={slug!} /> : null}
  {entryType === "moreInfo" ? <MoreInfo moreInfoId={slug!} /> : null}
  {entryType === "no-match" ? <System /> : null}
</Layout>
